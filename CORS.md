
### **يعني إيه CORS؟**

**الـ CORS** اختصار لـ **Cross-Origin Resource Sharing**، واللي معناها "مشاركة الموارد بين مواقع مختلفة".

الموضوع ده بيخص **الـ Browser**، وبيتحكم في إزاي موقع معين يقدر يطلب بيانات أو يتعامل مع سيرفر تاني (يعني دومين تاني).

### **إيه المشكلة أصلاً؟**

الـ Browser بيشتغل بسياسة اسمها **Same-Origin Policy (SOP)**، يعني:

> "الموقع ماينفعش يطلب بيانات من دومين تاني غير اللي هو جاي منه... إلا لو الدومين التاني وافق."

ودي معمولة علشان **تحمي المستخدم** من مواقع خبيثة تحاول تسرق بياناته.

### **هنا بييجي دور CORS**

الـ CORS بيحل المشكلة دي، وبيخلي فيه **طريقة آمنة** إن موقع يتعامل مع دومين تاني **لكن بشكل متحكم فيه**.

يعني لو أنا فاتح موقع `example.com`، وعايز أطلب بيانات من `api.another-site.com`، السيرفر التاني لازم **يبعت في الهيدر رد اسمه `Access-Control-Allow-Origin`** يقول فيه إنه موافق يدي بيانات للموقع الأول.

### **طيب، هل CORS بيحمي من الهجمات؟**

المفروض إنه بيساعد في التحكم، لكن:

> ❌ **الـ CORS مش وسيلة حماية من هجمات زي CSRF (Cross-Site Request Forgery)**  
> ✅ هو مجرد طريقة تقول مين يقدر يتعامل مع السيرفر، لكن **مش بيمنع الهجوم نفسه** لو الإعدادات غلط.

يعني لو السيرفر عامل إعدادات CORS بشكل غلط، ممكن موقع خبيث يستغل ده ويهاجم المستخدمين.

---

### ✅ **يعني إيه Same-Origin Policy؟**

هي **سياسة أمان في المتصفحات**، ومعناها:

> "الموقع اللي إنت فاتحه في المتصفح **ماينفعش** يتفاعل (يعني ياخد أو يعدل بيانات) مع موقع تاني غير نفسه... إلا بشروط خاصة."

### 🧠 طب يعني إيه "Same-Origin" أصلاً؟

الـ **Origin** معناها أصل، والمقصود هنا هو:

- **البروتوكول**: زي `http` أو `https`
    
- **الدومين**: زي `example.com`
    
- **البورت**: زي `3000:` أو `80:`

### 🛡️ ليه عملوا السياسة دي؟

المتصفحات طبّقت الـ Same-Origin Policy علشان **تحمي بيانات المستخدم**.  
تخيل لو إنت فاتح موقع البنك، وفي تبويب تاني فاتح موقع فيه كود خبيث،  
الكود ده ممكن يحاول يوصل لبيانات البنك! 🥶

علشان كده، المتصفح بيقول:

> "أنا مش هخلي الموقع الخبيث يعرف حاجة عن موقع البنك، ولا يقرأ البيانات بتاعته."

---
### 🧱 أول حاجة: الـ Same-Origin Policy "صارمة جدًا"

زي ما اتكلمنا قبل كده، سياسة **Same-Origin** بتحمي المستخدمين عن طريق إنها تمنع المواقع إنها تتعامل مع دومينات تانية (مواقع تانية)، وده كويس للأمان...  
لكن أوقات بيكون فيه **حالات مش هينفع نشتغل من غير ما نخالف القاعدة دي**!

### 🎯 طب إمتى نحتاج "نرخي" السياسة دي شوية؟

في حالات زي:

- موقع بيتعامل مع **subdomain** (مثلاً `api.example.com` بيتعامل مع `www.example.com`)
    
- أو بيتعامل مع **مواقع خارجية موثوقة** (زي موقع بيستخدم خدمة دفع زي PayPal أو Stripe)
    
- أو بيطلب بيانات من **API موجود على سيرفر تاني**
    

فـ لازم نلاقي طريقة نخلّي المتصفح **يسمح بالتعامل مع الدومين التاني**... بس **بشكل آمن ومتحكم فيه**.

### 🔓 هنا بييجي دور "Relaxation" of Same-Origin Policy

يعني:

> **نرخي شوية** من الشروط بتاعة السياسة، لكن مش نكسرها تمامًا.

وده بيتحقق عن طريق بروتوكول اسمه:

### 🔧 الـ **CORS – Cross-Origin Resource Sharing**

---
### 💡 إزاي CORS بيشتغل؟

الـ CORS بيستخدم **مجموعة من الهيدرز (HTTP Headers)**  
الهيدرز دي بتتبعت من السيرفر للمتصفح علشان تقول له:

> "آه، أنا موافق إن موقع كذا يطلب مني بيانات، وممكن كمان أسمح بالكوكيز أو الدخول بحساب مستخدم."

الهيدرز دي بتتضمن معلومات زي:

- مين الدومين المسموح له يطلب البيانات (مثلاً: `https://myfrontend.com`)
    
- هل نسمح بالكوكيز والدخول بحساب؟ (`Access-Control-Allow-Credentials`)
    
- نوع الطلبات المسموح بيها (GET – POST – PUT…)
### 🔁 إزاي بيتم تبادل الهيدرز؟

فيه زي "محادثة" بتحصل بين المتصفح والسيرفر:

1. المتصفح بيبعت طلب اسمه **Preflight Request** (استكشافي)
    
2. السيرفر بيرد عليه بالهيدرز ويقول: "أيوه، أنا موافق"
    
3. المتصفح لو شاف الرد موافق، بيكمل الطلب الأساسي.

### 💥 يعني إيه "Vulnerabilities arising from CORS configuration issues"؟

يعني:

> "ثغرات أو مشاكل أمان بتحصل بسبب إعدادات CORS الغلط."

### 🧠 الخلفية:

المواقع الحديثة كتير بتستخدم **CORS** علشان تخلّي فيه تواصل بين الموقع الرئيسي و:

- الـ **Subdomains** (زي `api.example.com`)
    
- أو **أطراف خارجية موثوق فيها** (زي خدمات الدفع أو مواقع تانية شغالة معاها)
    

ودي حاجة كويسة ومهمة، بس...

### ⚠️ المشكلة فين؟

بعض المطورين لما بييجوا يظبطوا إعدادات CORS، ممكن:

- **يغلطوا** في الإعدادات
    
- أو يتساهلوا أوي علشان "كل حاجة تشتغل" بدون مشاكل
    

لكن ده ممكن يفتح الباب لهجمات واختراقات!

### 🧨 أمثلة على إعدادات خاطئة وخطيرة:

#### 1. السماح لكل المواقع بالوصول:
```http
Access-Control-Allow-Origin: *
```
ده معناه:

> "أي موقع في الدنيا يقدر يطلب بيانات من السيرفر بتاعي!"

ودي كارثة، خصوصًا لو السيرفر بيرجع **بيانات حساسة** (زي معلومات حسابات أو بيانات مستخدمين).

---

#### 2. السماح بالدومين اللي جاي في الطلب (ديناميكيًا) من غير تحقق:

يعني السيرفر بيقول:
```javascript
res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
```
ده معناه:

> "أي موقع يبعتلي، أنا هرد عليه كأني واثق فيه!"  
> وده بيخلّي الهاكرز يقدروا **يبعتوا طلبات باسم مواقعهم وياخدوا الرد عادي جدًا**.

---

#### 3. السماح بـ Credentials مع `*`:
```http
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
```
المتصفح في الحالة دي **بيرفض** الطلب، بس دي تعتبر **إعدادات غلط وخطيرة** لو اتحايل عليها ممكن تسبب ثغرة.

### 🔐 طيب إزاي نتجنب الثغرات دي؟

- حدد بدقة المواقع المسموح لها (مثلاً `https://myfrontend.com` بس)
    
- ماتستخدمش `*` مع معلومات حساسة أو مع الكوكيز
    
- ماتخليش الإعدادات ديناميكية من غير تحقق
    
- اختبر إعدادات CORS بتاعتك كويس جدًا


### ليه لما ببلغ ثغرة CORS misconfiguration بتترفض؟

لو واحد بس من الشروط التالية متحققش, فدي بإختصار مش ثغرة misconfigured cors فمش هتتقبل.

- لازم يبقي الهيدرز اللي في الريسبونس فيها كمان الهيدر بتاع Access-Control-Allow-Credentials وتكون قيمته True عشان يبقي مسموحلك تعمل authenticated requests
    

- لازم ميبقاش في اي هيدر زيادة في الركوست نفسها زي ال authorization وغيره عشان ده مش هيخليك تقدر تستغل الثغرة لانك مش هتعرف تضيف هيدر للركوست
    

- وأخيرا, لازم يبقي الصفحة نفسها فيها بيانات مهمه وإلا المخترق هيستفيد ايه لو استغلها من غير ما يكون في الصفحه بيانات مهمه؟
    

حاجة أخيرة محتاج أأكد عليها كتير, وهي انك لازم الأول تفهم ايه هي ال CORS وليه انا كمبرمج محتاج أخليها متاحه في موقعي؟ لأن زي ما قولت لازم تفهم التكنولوجي الأول عشان تعرف تفهم ثغراتها.

